#include <HID.h>
#include <Keyboard.h>

// REF: https://divinus41.itch.io/space-invaders

// Pinos do rotary encoder
#define PIN_SW  3   // Switch (botão)
#define PIN_DT  4   // DT
#define PIN_CLK 5   // CLK

// Estado anterior do encoder
int lastStateCLK;
int currentStateCLK;

// Debounce do botão
unsigned long lastButtonPress = 0;
const unsigned long debounceDelay = 200;

// Debounce do encoder
unsigned long lastEncoderMove = 0;
const unsigned long encoderDelay = 5;

void setup() {
  pinMode(PIN_SW, INPUT_PULLUP);
  pinMode(PIN_DT, INPUT_PULLUP);
  pinMode(PIN_CLK, INPUT_PULLUP);

  lastStateCLK = digitalRead(PIN_CLK);

  Keyboard.begin();
}

void loop() {
  // === Leitura do Rotary Encoder ===
  currentStateCLK = digitalRead(PIN_CLK);

  if (currentStateCLK != lastStateCLK && currentStateCLK == LOW) {
    unsigned long now = millis();
    if (now - lastEncoderMove > encoderDelay) {
      lastEncoderMove = now;

      if (digitalRead(PIN_DT) != currentStateCLK) {
        // Girou para a direita → seta direita
        Keyboard.press(KEY_RIGHT_ARROW);
        delay(50);
        Keyboard.release(KEY_RIGHT_ARROW);
      } else {
        // Girou para a esquerda → seta esquerda
        Keyboard.press(KEY_LEFT_ARROW);
        delay(50);
        Keyboard.release(KEY_LEFT_ARROW);
      }
    }
  }

  lastStateCLK = currentStateCLK;

  // === Leitura do Botão (Switch) ===
  if (digitalRead(PIN_SW) == LOW) {
    unsigned long now = millis();
    if (now - lastButtonPress > debounceDelay) {
      lastButtonPress = now;

      // Pressiona 'x' para atirar
      Keyboard.press('x');
      delay(50);
      Keyboard.release('x');
    }
  }
}
